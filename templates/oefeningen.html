{% extends "base.html" %}

{% block title %}VibeStudio - LeerVibeCoding.nl{% endblock %}

{% block extra_css %}
<style>
    body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); overflow-x: hidden; }
    
    /* Header */
    .studio-header {
        padding: 12px 0;
        background: rgba(0,0,0,0.3);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .studio-header-inner {
        display: flex; justify-content: space-between; align-items: center;
        flex-wrap: wrap; gap: 12px;
    }
    .studio-title { font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .studio-title span { 
        background: linear-gradient(135deg, #a855f7, #22d3ee);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    
    /* XP & Level Bar */
    .xp-section { display: flex; align-items: center; gap: 16px; }
    .level-info { display: flex; align-items: center; gap: 8px; }
    .level-badge {
        background: linear-gradient(135deg, #a855f7, #8b5cf6);
        padding: 5px 12px; border-radius: 16px; font-weight: 600; font-size: 13px;
    }
    .level-bar-container { width: 120px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .level-bar { height: 100%; background: linear-gradient(90deg, #a855f7, #22d3ee); border-radius: 10px; transition: width 0.5s; }
    .xp-text { font-size: 13px; color: rgba(255,255,255,0.7); }

    /* Project Selector */
    .project-selector {
        padding: 16px 0;
        background: rgba(255,255,255,0.03);
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .selector-hook {
        text-align: center; margin-bottom: 14px;
        font-size: 16px; color: rgba(255,255,255,0.8);
    }
    .selector-hook strong { color: #22d3ee; }
    
    /* Level Tabs */
    .level-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 14px; }
    .level-tab {
        padding: 10px 24px; border-radius: 30px; font-weight: 600; cursor: pointer;
        background: rgba(255,255,255,0.06); border: 2px solid rgba(255,255,255,0.1);
        transition: all 0.3s; font-size: 14px; color: #fff;
    }
    .level-tab:hover { background: rgba(255,255,255,0.1); }
    .level-tab.active.green { background: #22c55e; border-color: #22c55e; }
    .level-tab.active.orange { background: #f59e0b; border-color: #f59e0b; color: #000; }
    .level-tab.active.red { background: #ef4444; border-color: #ef4444; }

    /* Project Pills */
    .project-nav { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .project-pill {
        padding: 8px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
        border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #fff;
    }
    .project-pill:hover { background: rgba(255,255,255,0.15); }
    .project-pill.active { background: var(--purple); border-color: var(--purple); }
    .project-pill .xp { font-size: 10px; opacity: 0.7; margin-left: 4px; }

    /* SPLIT SCREEN STUDIO */
    .studio-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 180px);
        gap: 0;
    }

    /* LEFT PANEL - Instructie Kamer */
    .instruction-panel {
        padding: 24px;
        background: rgba(0,0,0,0.2);
        border-right: 1px solid rgba(255,255,255,0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        max-height: 100%;
    }

    /* Client Chat Message */
    .client-message {
        display: flex; gap: 14px; margin-bottom: 16px;
        animation: slideIn 0.4s ease;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    
    .client-avatar {
        width: 48px; height: 48px; border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b, #ea580c);
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; flex-shrink: 0;
    }
    .client-bubble {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 16px; border-top-left-radius: 4px;
        padding: 16px; max-width: 100%;
    }
    .client-name { font-weight: 600; color: #f59e0b; margin-bottom: 6px; font-size: 13px; }
    .client-text { color: rgba(255,255,255,0.9); font-size: 15px; line-height: 1.5; }
    
    /* Expand Button */
    .expand-btn {
        margin-top: 10px; background: none; border: none; color: #22d3ee;
        font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px;
        padding: 0;
    }
    .expand-btn:hover { text-decoration: underline; }
    .expand-content {
        display: none; margin-top: 12px; padding: 12px;
        background: rgba(34,211,238,0.1); border-radius: 10px;
    }
    .expand-content.show { display: block; }
    .expand-content li { color: rgba(255,255,255,0.8); margin-bottom: 6px; padding-left: 18px; position: relative; font-size: 13px; }
    .expand-content li:before { content: "‚úì"; position: absolute; left: 0; color: #22d3ee; }

    /* Input Section */
    .input-section { margin-top: 16px; flex-shrink: 0; }
    .input-label { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: rgba(255,255,255,0.9); }
    
    /* Suggestion Chips */
    .suggestion-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
    .chip {
        padding: 6px 12px; background: rgba(168,85,247,0.15); border: 1px solid rgba(168,85,247,0.3);
        border-radius: 16px; font-size: 12px; color: #c4b5fd; cursor: pointer;
        transition: all 0.2s;
    }
    .chip:hover { background: rgba(168,85,247,0.25); border-color: rgba(168,85,247,0.5); color: white; }
    .chip i { margin-right: 4px; }

    /* Text Input */
    .magic-input-wrapper { position: relative; }
    .magic-input {
        width: 100%; min-height: 80px; padding: 14px;
        background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.15);
        border-radius: 12px; color: white; font-family: inherit; font-size: 14px;
        resize: none; transition: all 0.3s;
    }
    .magic-input:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 20px rgba(168,85,247,0.2); }
    .magic-input::placeholder { color: rgba(255,255,255,0.4); }
    
    /* Send Button */
    .send-btn {
        margin-top: 12px; width: 100%; padding: 14px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border: none; border-radius: 10px; color: white;
        font-size: 15px; font-weight: 600; cursor: pointer;
        transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .send-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(34,197,94,0.4); }
    .send-btn.typing { animation: glow 1.5s infinite; }
    @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(34,197,94,0.4); }
        50% { box-shadow: 0 0 40px rgba(34,197,94,0.6); }
    }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* RIGHT PANEL - Magische Spiegel */
    .preview-panel {
        background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* Preview Header */
    .preview-header {
        padding: 12px 20px;
        background: rgba(0,0,0,0.3);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
    }
    .preview-title { font-size: 13px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 6px; }
    .preview-title i { color: #a855f7; }
    
    /* Client Satisfaction */
    .satisfaction {
        display: flex; align-items: center; gap: 8px;
        background: rgba(255,255,255,0.08); padding: 6px 12px; border-radius: 16px;
    }
    .satisfaction-label { font-size: 11px; color: rgba(255,255,255,0.6); }
    .satisfaction-emoji { font-size: 20px; transition: all 0.3s; }
    .satisfaction-bar { width: 60px; height: 5px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .satisfaction-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e); border-radius: 10px; transition: width 0.5s; }

    /* Preview Content */
    .preview-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
    }

    /* Empty State */
    .empty-state {
        text-align: center; color: rgba(255,255,255,0.4);
        display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    .empty-icon { font-size: 60px; opacity: 0.3; }
    .empty-text { font-size: 16px; }
    .empty-hint { font-size: 13px; color: rgba(255,255,255,0.3); }

    /* Preview Frame */
    .preview-frame {
        width: 100%; height: 100%; background: white;
        border-radius: 12px; overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        display: none;
    }
    .preview-frame.show { display: block; }
    .preview-frame iframe { width: 100%; height: 100%; border: none; }

    /* Sparkle Animation */
    .sparkle-overlay {
        position: absolute; inset: 0;
        background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(34,211,238,0.3));
        display: none; align-items: center; justify-content: center;
        z-index: 10;
    }
    .sparkle-overlay.show { display: flex; animation: sparkle 1s ease-out forwards; }
    @keyframes sparkle {
        0% { opacity: 1; }
        100% { opacity: 0; }
    }
    .sparkle-text { font-size: 48px; animation: bounce 0.5s ease; }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    /* AI Response */
    .ai-response {
        margin-top: 12px; padding: 12px;
        background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3);
        border-radius: 12px; display: none;
    }
    .ai-response.show { display: block; animation: slideIn 0.4s ease; }
    .ai-response-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .ai-avatar {
        width: 28px; height: 28px; border-radius: 50%;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        display: flex; align-items: center; justify-content: center; font-size: 14px;
    }
    .ai-name { font-weight: 600; color: #4ade80; font-size: 13px; }
    .ai-text { color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.5; }

    /* Improvement Suggestions */
    .improvements {
        margin-top: 12px; padding: 12px;
        background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3);
        border-radius: 10px; display: none;
    }
    .improvements.show { display: block; }
    .improvements h5 { color: #fbbf24; font-size: 13px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .improvement-item {
        padding: 8px 12px; margin-bottom: 6px;
        background: rgba(255,255,255,0.05); border-radius: 8px;
        color: rgba(255,255,255,0.8); font-size: 13px;
        cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; gap: 8px;
    }
    .improvement-item:hover { background: rgba(255,255,255,0.1); }
    .improvement-item i { color: #fbbf24; }

    /* Success State */
    .success-banner {
        margin-top: 12px; padding: 16px;
        background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,211,238,0.15));
        border: 2px solid rgba(34,197,94,0.4);
        border-radius: 12px; text-align: center; display: none;
    }
    .success-banner.show { display: block; animation: slideIn 0.4s ease; }
    .success-banner h4 { color: #4ade80; font-size: 18px; margin-bottom: 6px; }
    .success-banner p { color: rgba(255,255,255,0.7); margin-bottom: 12px; font-size: 14px; }
    .success-xp { font-size: 24px; font-weight: 700; color: #facc15; }
    .next-btn {
        margin-top: 12px; padding: 12px 28px;
        background: linear-gradient(135deg, #a855f7, #8b5cf6);
        border: none; border-radius: 10px; color: white;
        font-size: 15px; font-weight: 600; cursor: pointer;
    }
    .next-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(168,85,247,0.4); }

    /* Loading Overlay */
    .loading-overlay {
        position: absolute; inset: 0;
        background: rgba(0,0,0,0.8);
        display: none; align-items: center; justify-content: center;
        z-index: 20; border-radius: 16px;
    }
    .loading-overlay.show { display: flex; }
    .loading-spinner {
        width: 50px; height: 50px;
        border: 4px solid rgba(255,255,255,0.1);
        border-top-color: #a855f7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 900px) {
        .studio-container { grid-template-columns: 1fr; }
        .preview-panel { min-height: 400px; }
        .level-tabs { flex-wrap: wrap; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Studio Header -->
<header class="studio-header">
    <div class="container">
        <div class="studio-header-inner">
            <div class="studio-title">
                <span>üé¨ VibeStudio</span>
            </div>
            <div class="xp-section">
                <div class="level-info">
                    <span class="level-badge" id="levelBadge">Level 1</span>
                    <div class="level-bar-container">
                        <div class="level-bar" id="levelBar" style="width: 0%"></div>
                    </div>
                </div>
                <span class="xp-text"><span id="xpDisplay">0</span> XP</span>
            </div>
        </div>
    </div>
</header>

<!-- Project Selector -->
<section class="project-selector">
    <div class="container">
        <p class="selector-hook">Kies een project en word de <strong>regisseur</strong> van je eigen software. Jij praat, de AI bouwt.</p>
        
        <div class="level-tabs">
            <button class="level-tab green active" data-level="makkelijk">üå± Beginner</button>
            <button class="level-tab orange" data-level="gemiddeld">üî• Gemiddeld</button>
            <button class="level-tab red" data-level="moeilijk">üöÄ Gevorderd</button>
        </div>
        
        <div class="project-nav" id="projectNav"></div>
    </div>
</section>

<!-- Split Screen Studio -->
<div class="studio-container">
    <!-- LEFT: Instruction Panel -->
    <div class="instruction-panel">
        <!-- Client Message -->
        <div class="client-message">
            <div class="client-avatar" id="clientAvatar">üë©‚Äçüç≥</div>
            <div class="client-bubble">
                <div class="client-name" id="clientName">Fatima</div>
                <div class="client-text" id="clientText">Hoi! Kun je me helpen?</div>
                <button class="expand-btn" onclick="toggleRequirements()">
                    <i class="fas fa-list-check"></i> Wat moet er precies op?
                </button>
                <div class="expand-content" id="requirementsList"></div>
            </div>
        </div>

        <!-- AI Response -->
        <div class="ai-response" id="aiResponse">
            <div class="ai-response-header">
                <div class="ai-avatar">ü§ñ</div>
                <span class="ai-name">VibeBot</span>
            </div>
            <div class="ai-text" id="aiText"></div>
        </div>

        <!-- Improvements -->
        <div class="improvements" id="improvements">
            <h5><i class="fas fa-magic"></i> Probeer dit te zeggen:</h5>
            <div id="improvementsList"></div>
        </div>

        <!-- Success Banner -->
        <div class="success-banner" id="successBanner">
            <h4>üéâ De klant is tevreden!</h4>
            <p>Je hebt het perfect gedaan.</p>
            <div class="success-xp">+<span id="earnedXp">0</span> XP</div>
            <button class="next-btn" onclick="nextProject()">
                <i class="fas fa-arrow-right"></i> Volgend Project
            </button>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-label">üí¨ Vertel de computer wat hij moet maken:</div>
            
            <div class="suggestion-chips" id="suggestionChips"></div>
            
            <div class="magic-input-wrapper">
                <textarea class="magic-input" id="magicInput" placeholder="Bijv: Maak een mooie welkomsttekst met de naam van de bakkerij..."></textarea>
            </div>
            
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <i class="fas fa-wand-magic-sparkles"></i> Maak het!
            </button>
        </div>
    </div>

    <!-- RIGHT: Preview Panel -->
    <div class="preview-panel">
        <div class="preview-header">
            <div class="preview-title"><i class="fas fa-eye"></i> Live Preview</div>
            <div class="satisfaction">
                <span class="satisfaction-label">Klanttevredenheid:</span>
                <span class="satisfaction-emoji" id="satisfactionEmoji">üòê</span>
                <div class="satisfaction-bar">
                    <div class="satisfaction-fill" id="satisfactionFill" style="width: 50%"></div>
                </div>
            </div>
        </div>
        
        <div class="preview-content">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üèóÔ∏è</div>
                <div class="empty-text">Hier verschijnt straks jouw creatie</div>
                <div class="empty-hint">Schrijf links je opdracht en klik op "Maak het!"</div>
            </div>
            
            <!-- Preview Frame -->
            <div class="preview-frame" id="previewFrame">
                <iframe id="previewIframe"></iframe>
            </div>
            
            <!-- Sparkle Overlay -->
            <div class="sparkle-overlay" id="sparkleOverlay">
                <span class="sparkle-text">‚ú®</span>
            </div>
            
            <!-- Loading -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const exercises = {{ exercises | tojson }};
let currentLevel = 'makkelijk';
let currentEx = null;
let xp = parseInt(localStorage.getItem('vibeXp') || '0');
let satisfaction = 50;

// Client personas
const clientPersonas = {
    'm1': { avatar: 'üë©‚Äçüç≥', name: 'Fatima', color: '#f59e0b' },
    'm2': { avatar: 'üë¶', name: 'Max', color: '#3b82f6' },
    'm3': { avatar: 'üéâ', name: 'Ahmed', color: '#22c55e' },
    'm4': { avatar: 'üíá‚Äç‚ôÄÔ∏è', name: 'Kim', color: '#ec4899' },
    'm5': { avatar: 'üëµ', name: 'Oma', color: '#f59e0b' },
    'm6': { avatar: '‚öΩ', name: 'De Trainer', color: '#22c55e' },
    'm7': { avatar: '‚òï', name: 'Caf√© eigenaar', color: '#92400e' },
    'm8': { avatar: 'üêï', name: 'Dierenpension', color: '#f59e0b' },
    'm9': { avatar: 'üßò', name: 'Yoga Instructeur', color: '#8b5cf6' },
    'm10': { avatar: 'üìö', name: 'Boekenclub', color: '#3b82f6' },
    'g1': { avatar: 'üçù', name: 'Bella Italia', color: '#ef4444' },
    'g2': { avatar: 'üì∏', name: 'Lisa', color: '#ec4899' },
    'g3': { avatar: 'üí™', name: 'PowerFit', color: '#22c55e' },
    'g4': { avatar: 'üéß', name: 'TechGadgets', color: '#3b82f6' },
    'g5': { avatar: 'üõí', name: 'ShopSlim', color: '#f59e0b' },
    'g6': { avatar: 'üöÄ', name: 'BrandBoost', color: '#8b5cf6' },
    'g7': { avatar: 'üì∞', name: 'DailyTips', color: '#22d3ee' },
    'g8': { avatar: '‚òÅÔ∏è', name: 'CloudTools', color: '#3b82f6' },
    'g9': { avatar: 'üè®', name: 'Hotel ZeeZicht', color: '#22d3ee' },
    'g10': { avatar: '‚öñÔ∏è', name: 'Advocatenkantoor', color: '#6b7280' },
    'mo1': { avatar: 'üë©‚Äçüíº', name: 'Emma', color: '#ec4899' },
    'mo2': { avatar: 'üë®‚Äçüè´', name: 'Docent Henk', color: '#3b82f6' },
    'mo3': { avatar: 'üè´', name: 'De Rekenster', color: '#22c55e' },
    'mo4': { avatar: 'üì∫', name: 'DagelijksNieuws', color: '#ef4444' },
    'mo5': { avatar: 'üë©‚Äçüéì', name: 'Julia', color: '#8b5cf6' },
    'mo6': { avatar: 'üèÉ', name: 'Coach Thomas', color: '#22c55e' },
    'mo7': { avatar: 'üè†', name: 'Sanne & Tim', color: '#f59e0b' },
    'mo8': { avatar: 'üìã', name: 'Anna', color: '#ec4899' },
    'mo9': { avatar: 'üçΩÔ∏è', name: 'De Gouden Lepel', color: '#f59e0b' },
    'mo10': { avatar: 'üåü', name: 'Jij!', color: '#a855f7' }
};

// Init
updateXPDisplay();

document.querySelectorAll('.level-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.level-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentLevel = tab.dataset.level;
        renderProjects();
    });
});

// Typing detection for glow effect
document.getElementById('magicInput').addEventListener('input', function() {
    const btn = document.getElementById('sendBtn');
    if (this.value.length > 0) {
        btn.classList.add('typing');
    } else {
        btn.classList.remove('typing');
    }
});

function renderProjects() {
    const nav = document.getElementById('projectNav');
    const exs = exercises[currentLevel];
    nav.innerHTML = exs.map((e, i) => 
        `<button class="project-pill ${i===0?'active':''}" data-id="${e.id}">${i+1}. ${e.title}<span class="xp">${e.points}XP</span></button>`
    ).join('');
    
    nav.querySelectorAll('.project-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            nav.querySelectorAll('.project-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            loadProject(pill.dataset.id);
        });
    });
    
    loadProject(exs[0].id);
}

function loadProject(id) {
    currentEx = exercises[currentLevel].find(e => e.id === id);
    const persona = clientPersonas[id] || { avatar: 'üë§', name: 'Klant', color: '#a855f7' };
    
    // Update client
    document.getElementById('clientAvatar').textContent = persona.avatar;
    document.getElementById('clientAvatar').style.background = `linear-gradient(135deg, ${persona.color}, ${adjustColor(persona.color, -30)})`;
    document.getElementById('clientName').textContent = persona.name;
    document.getElementById('clientName').style.color = persona.color;
    document.getElementById('clientText').textContent = currentEx.scenario;
    
    // Requirements list
    document.getElementById('requirementsList').innerHTML = currentEx.hints.map(h => `<li>${h}</li>`).join('');
    document.getElementById('requirementsList').classList.remove('show');
    
    // Suggestion chips
    const chips = currentEx.hints.slice(0, 3).map(h => 
        `<button class="chip" onclick="addSuggestion('${h.replace(/'/g, "\\'")}')"><i class="fas fa-plus"></i>${h.substring(0, 40)}${h.length > 40 ? '...' : ''}</button>`
    ).join('');
    document.getElementById('suggestionChips').innerHTML = chips;
    
    // Reset UI
    resetUI();
}

function adjustColor(color, amount) {
    return color; // Simplified
}

function resetUI() {
    document.getElementById('magicInput').value = '';
    document.getElementById('aiResponse').classList.remove('show');
    document.getElementById('improvements').classList.remove('show');
    document.getElementById('successBanner').classList.remove('show');
    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('previewFrame').classList.remove('show');
    document.getElementById('sendBtn').classList.remove('typing');
    satisfaction = 50;
    updateSatisfaction();
}

function toggleRequirements() {
    document.getElementById('requirementsList').classList.toggle('show');
}

function addSuggestion(text) {
    const input = document.getElementById('magicInput');
    input.value += (input.value ? ' ' : '') + text;
    input.focus();
    document.getElementById('sendBtn').classList.add('typing');
}

async function sendMessage() {
    const prompt = document.getElementById('magicInput').value.trim();
    if (!prompt) return;
    
    // Show loading
    document.getElementById('loadingOverlay').classList.add('show');
    document.getElementById('sendBtn').disabled = true;
    
    try {
        const res = await fetch('/api/submit-prompt', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prompt, exercise_id: currentEx.id})
        });
        const data = await res.json();
        
        if (data.success) {
            // Hide loading, show sparkle
            document.getElementById('loadingOverlay').classList.remove('show');
            document.getElementById('sparkleOverlay').classList.add('show');
            setTimeout(() => document.getElementById('sparkleOverlay').classList.remove('show'), 1000);
            
            // Update preview
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('previewFrame').classList.add('show');
            updatePreview(data.response);
            
            // Calculate satisfaction
            const criteriaCount = currentEx.success_criteria.length;
            const metCount = currentEx.success_criteria.filter(c => 
                data.response.toLowerCase().includes(c.toLowerCase())
            ).length;
            satisfaction = Math.round((metCount / criteriaCount) * 100);
            updateSatisfaction();
            
            // AI Response
            const aiText = document.getElementById('aiText');
            if (data.exercise_success) {
                aiText.textContent = `Perfect! Ik heb precies gemaakt wat ${clientPersonas[currentEx.id]?.name || 'de klant'} wilde. De klant is super tevreden! üéâ`;
                document.getElementById('aiResponse').classList.add('show');
                
                // Show success
                document.getElementById('earnedXp').textContent = data.points_earned;
                document.getElementById('successBanner').classList.add('show');
                document.getElementById('improvements').classList.remove('show');
                
                // Update XP
                xp += data.points_earned;
                localStorage.setItem('vibeXp', xp);
                updateXPDisplay();
            } else {
                aiText.textContent = `Ik heb dit voor je gemaakt! Maar ${clientPersonas[currentEx.id]?.name || 'de klant'} wil nog een paar aanpassingen...`;
                document.getElementById('aiResponse').classList.add('show');
                
                // Show improvements
                const missing = currentEx.hints.filter((h, i) => i < 3);
                document.getElementById('improvementsList').innerHTML = missing.map(h =>
                    `<div class="improvement-item" onclick="addSuggestion('${h.replace(/'/g, "\\'")}')"><i class="fas fa-comment"></i>"${h}"</div>`
                ).join('');
                document.getElementById('improvements').classList.add('show');
                document.getElementById('successBanner').classList.remove('show');
                
                if (data.points_earned > 0) {
                    xp += data.points_earned;
                    localStorage.setItem('vibeXp', xp);
                    updateXPDisplay();
                }
            }
        }
    } catch(e) {
        console.error(e);
    } finally {
        document.getElementById('loadingOverlay').classList.remove('show');
        document.getElementById('sendBtn').disabled = false;
    }
}

function updatePreview(response) {
    const iframe = document.getElementById('previewIframe');
    let html = response.match(/```html([\s\S]*?)```/i)?.[1]?.trim() || 
               (response.includes('<') ? response : `<pre>${response}</pre>`);
    iframe.srcdoc = html;
}

function updateSatisfaction() {
    document.getElementById('satisfactionFill').style.width = satisfaction + '%';
    const emoji = document.getElementById('satisfactionEmoji');
    if (satisfaction >= 90) emoji.textContent = 'üòç';
    else if (satisfaction >= 70) emoji.textContent = 'üòä';
    else if (satisfaction >= 50) emoji.textContent = 'üòê';
    else if (satisfaction >= 30) emoji.textContent = 'üòï';
    else emoji.textContent = 'üò¢';
}

function updateXPDisplay() {
    document.getElementById('xpDisplay').textContent = xp;
    const level = Math.floor(xp / 200) + 1;
    const progress = (xp % 200) / 200 * 100;
    document.getElementById('levelBadge').textContent = 'Level ' + level;
    document.getElementById('levelBar').style.width = progress + '%';
}

function nextProject() {
    const exs = exercises[currentLevel];
    const idx = exs.findIndex(e => e.id === currentEx.id);
    if (idx < exs.length - 1) {
        document.querySelectorAll('.project-pill')[idx + 1].click();
    } else {
        const levels = ['makkelijk', 'gemiddeld', 'moeilijk'];
        const lvlIdx = levels.indexOf(currentLevel);
        if (lvlIdx < 2) {
            document.querySelectorAll('.level-tab')[lvlIdx + 1].click();
        }
    }
}

// Init
const urlParams = new URLSearchParams(window.location.search);
const levelParam = urlParams.get('level');
if (levelParam && exercises[levelParam]) {
    document.querySelector(`[data-level="${levelParam}"]`).click();
} else {
    renderProjects();
}
</script>
{% endblock %}
