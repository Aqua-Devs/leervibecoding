{% extends "base.html" %}

{% block title %}Oefenruimte - Leer Vibecoding met Opdrachten | LeerVibeCoding{% endblock %}
{% block meta_description %}Oefen vibecoding met interactieve opdrachten. Van HTML basics tot complete AI-apps.{% endblock %}

{% block extra_css %}
<style>
/* ===========================================
   OEFENRUIMTE - Dark Mode with Red Accent
   =========================================== */

body { overflow-x: hidden; }

/* Studio Header */
.studio-header {
    padding: 12px 0;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 70px;
    z-index: 100;
}

.studio-header-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}

.studio-title {
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text1);
}

.studio-title span {
    color: var(--primary);
    font-weight: 700;
}

/* Level & XP */
.stats-bar {
    display: flex;
    align-items: center;
    gap: 20px;
}

.level-display {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--primary-light);
    padding: 8px 16px;
}

.level-num {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
}

.level-name {
    font-size: 12px;
    color: var(--text3);
}

.xp-display {
    font-size: 16px;
    color: var(--yellow);
    font-weight: 600;
}

.xp-bar {
    width: 120px;
    height: 6px;
    background: var(--border);
    overflow: hidden;
}

.xp-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.5s;
}

/* Main Studio Layout */
.studio-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: calc(100vh - 140px);
}

/* Left Panel */
.left-panel {
    display: flex;
    flex-direction: column;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    overflow: hidden;
}

/* Assignment Section */
.assignment-section {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
    position: relative;
    min-height: 300px;
}

.assignment-card {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 24px;
    margin-bottom: 16px;
}

.assignment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.assignment-level {
    background: var(--primary-light);
    padding: 4px 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--primary);
    text-transform: uppercase;
}

.assignment-level.ai {
    background: var(--green-light);
    color: var(--green);
}

.client-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.client-avatar {
    font-size: 36px;
}

.client-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
}

.scenario-text {
    color: var(--text2);
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 20px;
}

.task-box {
    background: var(--primary-light);
    border: 1px solid var(--primary);
    padding: 16px;
    margin-bottom: 20px;
}

.task-label {
    font-size: 11px;
    color: var(--primary);
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 8px;
}

.task-text {
    color: var(--text1);
    font-size: 14px;
    line-height: 1.6;
}

/* Requirements */
.requirements-box {
    margin-bottom: 20px;
}

.requirements-title {
    font-size: 13px;
    color: var(--text3);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.requirement-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px;
    margin-bottom: 8px;
    background: var(--bg);
    font-size: 14px;
    color: var(--text2);
    line-height: 1.5;
}

.requirement-item.met {
    background: var(--green-light);
    color: var(--green);
}

.requirement-item::before {
    content: "‚óã";
    color: var(--text3);
    flex-shrink: 0;
}

.requirement-item.met::before {
    content: "‚úì";
    color: var(--green);
    font-weight: bold;
}

/* Hints */
.hints-toggle {
    background: var(--blue-light);
    border: 1px solid var(--blue);
    padding: 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--blue);
    font-size: 13px;
    font-weight: 500;
}

.hints-toggle:hover {
    background: rgba(59,130,246,0.2);
}

.hints-content {
    display: none;
    padding: 12px;
    background: rgba(59,130,246,0.05);
    border: 1px solid var(--border);
    border-top: none;
}

.hints-content.show {
    display: block;
}

.hint-item {
    color: var(--text2);
    font-size: 14px;
    margin-bottom: 8px;
    padding-left: 24px;
    position: relative;
    line-height: 1.5;
}

.hint-item::before {
    content: "üí°";
    position: absolute;
    left: 0;
}

/* Input Section */
.input-section {
    padding: 20px;
    background: var(--bg3);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
}

.input-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text1);
}

.prompt-input {
    width: 100%;
    min-height: 100px;
    padding: 16px;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    resize: none;
    transition: border-color 0.2s;
}

.prompt-input:focus {
    outline: none;
    border-color: var(--primary);
}

.prompt-input::placeholder {
    color: var(--text3);
}

.btn-row {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.btn-submit {
    flex: 1;
    padding: 16px;
    background: var(--primary);
    border: none;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background 0.2s;
}

.btn-submit:hover {
    background: var(--primary-dark);
}

.btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-new {
    padding: 16px 24px;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-new:hover {
    border-color: var(--primary);
    color: var(--primary);
}

/* Right Panel */
.right-panel {
    display: flex;
    flex-direction: column;
    background: var(--bg);
}

/* Score Bar */
.score-bar {
    padding: 16px 20px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.score-label {
    font-size: 13px;
    color: var(--text3);
}

.score-display {
    display: flex;
    align-items: center;
    gap: 12px;
}

.score-percent {
    font-size: 24px;
    font-weight: 700;
    color: var(--text3);
}

.score-percent.low { color: var(--red); }
.score-percent.mid { color: var(--yellow); }
.score-percent.high { color: var(--green); }

.score-bar-visual {
    width: 150px;
    height: 8px;
    background: var(--border);
    overflow: hidden;
}

.score-bar-fill {
    height: 100%;
    background: var(--text3);
    transition: all 0.5s;
}

/* Preview Area */
.preview-area {
    flex: 1;
    position: relative;
    padding: 20px;
    overflow: hidden;
}

.preview-placeholder {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text3);
}

.preview-placeholder-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.preview-placeholder-text {
    font-size: 18px;
    margin-bottom: 8px;
}

.preview-placeholder-sub {
    font-size: 14px;
}

.preview-frame {
    display: none;
    width: 100%;
    height: 100%;
    background: white;
    overflow: hidden;
}

.preview-frame.show {
    display: block;
}

.preview-frame iframe {
    width: 100%;
    height: 100%;
    border: none;
}

/* Feedback Section */
.feedback-section {
    padding: 20px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    display: none;
    max-height: 200px;
    overflow-y: auto;
}

.feedback-section.show {
    display: block;
}

.feedback-message {
    padding: 14px;
    margin-bottom: 12px;
    font-size: 14px;
    font-weight: 500;
}

.feedback-message.success {
    background: var(--green-light);
    border: 1px solid var(--green);
    color: var(--green);
}

.feedback-message.partial {
    background: var(--yellow-light);
    border: 1px solid var(--yellow);
    color: var(--yellow);
}

.feedback-message.fail {
    background: var(--red-light);
    border: 1px solid var(--red);
    color: var(--red);
}

/* Loading */
.loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 10;
}

.loading-overlay.show {
    display: flex;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    color: white;
    font-size: 14px;
}

/* Level Up Modal */
.levelup-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.levelup-modal.show {
    display: flex;
}

.levelup-box {
    background: var(--card);
    border: 2px solid var(--primary);
    padding: 48px;
    text-align: center;
    max-width: 400px;
}

.levelup-emoji {
    font-size: 64px;
    margin-bottom: 16px;
}

.levelup-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--primary);
}

.levelup-text {
    font-size: 16px;
    color: var(--text2);
    margin-bottom: 24px;
}

.levelup-btn {
    padding: 14px 32px;
    background: var(--primary);
    border: none;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

/* API Key Notice */
.api-notice {
    background: var(--card);
    border: 1px solid var(--primary);
    padding: 24px;
    margin-bottom: 20px;
    text-align: center;
}

.api-notice h3 {
    font-size: 18px;
    margin-bottom: 8px;
}

.api-notice p {
    font-size: 14px;
    color: var(--text2);
    margin-bottom: 16px;
}

.api-notice .btn {
    padding: 12px 24px;
    background: var(--primary);
    color: white;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 48px 24px;
}

.empty-state .icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 20px;
    margin-bottom: 8px;
}

.empty-state p {
    font-size: 14px;
    color: var(--text3);
    margin-bottom: 24px;
}

/* Responsive */
@media (max-width: 900px) {
    .studio-main {
        grid-template-columns: 1fr;
    }
    .left-panel {
        border-right: none;
        border-bottom: 1px solid var(--border);
    }
    .right-panel {
        min-height: 50vh;
    }
}

@media (max-width: 600px) {
    .studio-header {
        top: 65px;
    }
    .studio-header-inner {
        flex-direction: column;
        align-items: flex-start;
    }
    .stats-bar {
        width: 100%;
        justify-content: space-between;
    }
    .level-display {
        padding: 6px 12px;
    }
    .level-num {
        font-size: 14px;
    }
    .assignment-card {
        padding: 16px;
    }
    .client-avatar {
        font-size: 28px;
    }
    .btn-row {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Studio Header -->
<div class="studio-header">
    <div class="container">
        <div class="studio-header-inner">
            <div class="studio-title">
                üß™ <span>Oefenruimte</span>
            </div>
            <div class="stats-bar">
                <div class="level-display">
                    <span class="level-num" id="currentLevel">1</span>
                    <span class="level-name" id="levelName">HTML Basics</span>
                </div>
                <div class="xp-display">
                    <span id="currentXP">0</span> XP
                </div>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Studio -->
<div class="studio-main">
    <!-- Left Panel -->
    <div class="left-panel">
        <div class="assignment-section">
            <!-- API Key Notice -->
            <div class="api-notice" id="apiNotice" style="display: none;">
                <h3>üîë API Key Vereist</h3>
                <p>Je hebt een OpenAI API key nodig om de oefenruimte te gebruiken.</p>
                <button class="btn" onclick="openApiKeyModal()">API Key Instellen</button>
            </div>

            <!-- Empty State - shown when API key exists but no assignment yet -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="icon">üéØ</div>
                <h3>Klaar om te beginnen?</h3>
                <p>Klik op de knop om je eerste opdracht te ontvangen.</p>
                <button class="btn btn-primary" onclick="generateAssignment()" style="padding: 14px 28px; background: var(--primary); color: white; border: none; font-size: 15px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-play"></i> Start Opdracht
                </button>
            </div>

            <!-- Assignment Card -->
            <div class="assignment-card" id="assignmentCard" style="display: none;">
                <div class="assignment-header">
                    <span class="assignment-level" id="assignmentLevel">Level 1</span>
                    <span id="assignmentXP" style="color: var(--yellow); font-weight: 600;">+30 XP</span>
                </div>
                
                <div class="client-info">
                    <span class="client-avatar" id="clientEmoji">üë©‚Äçüíº</span>
                    <span class="client-name" id="clientName">Klant</span>
                </div>
                
                <p class="scenario-text" id="scenarioText">Laadt...</p>
                
                <div class="task-box">
                    <div class="task-label">üìã Opdracht</div>
                    <div class="task-text" id="taskText">Laadt...</div>
                </div>
                
                <div class="requirements-box">
                    <div class="requirements-title"><i class="fas fa-check-circle"></i> Vereisten</div>
                    <div id="requirementsList"></div>
                </div>
                
                <div class="hints-toggle" onclick="toggleHints()">
                    <span>üí° Tips bekijken</span>
                    <i class="fas fa-chevron-down" id="hintsIcon"></i>
                </div>
                <div class="hints-content" id="hintsContent"></div>
            </div>

            <!-- Loading - initially shown -->
            <div class="loading-overlay show" id="assignmentLoading">
                <div class="spinner"></div>
                <div class="loading-text">Laden...</div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-label">‚úçÔ∏è Beschrijf wat je wilt bouwen</div>
            <textarea class="prompt-input" id="promptInput" placeholder="Beschrijf in je eigen woorden wat de website moet doen en hoe het eruit moet zien..."></textarea>
            <div class="btn-row">
                <button class="btn-submit" id="submitBtn" onclick="submitPrompt()" disabled>
                    <i class="fas fa-magic"></i> Genereer Code
                </button>
                <button class="btn-new" onclick="generateAssignment()">
                    <i class="fas fa-sync"></i> Nieuwe Opdracht
                </button>
            </div>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
        <div class="score-bar">
            <span class="score-label">Score</span>
            <div class="score-display">
                <span class="score-percent" id="scorePercent">-</span>
                <div class="score-bar-visual">
                    <div class="score-bar-fill" id="scoreFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="preview-area">
            <div class="preview-placeholder" id="previewPlaceholder">
                <div class="preview-placeholder-icon">üëÅÔ∏è</div>
                <div class="preview-placeholder-text">Preview</div>
                <div class="preview-placeholder-sub">Je code verschijnt hier</div>
            </div>
            <div class="preview-frame" id="previewFrame">
                <iframe id="previewIframe"></iframe>
            </div>

            <div class="loading-overlay" id="codeLoading">
                <div class="spinner"></div>
                <div class="loading-text">Code genereren...</div>
            </div>
        </div>

        <div class="feedback-section" id="feedbackSection">
            <div class="feedback-message" id="feedbackMessage"></div>
        </div>
    </div>
</div>

<!-- Level Up Modal -->
<div class="levelup-modal" id="levelupModal">
    <div class="levelup-box">
        <div class="levelup-emoji">üéâ</div>
        <div class="levelup-title">Level Up!</div>
        <div class="levelup-text" id="levelupText">Je bent nu Level 2!</div>
        <button class="levelup-btn" onclick="closeLevelUp()">Doorgaan</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let currentAssignment = null;
let apiKey = null;
let stats = {
    level: 1,
    xp: 0,
    completed: []
};

// Level thresholds
const LEVELS = [
    { level: 1, name: "HTML Basics", minXP: 0 },
    { level: 2, name: "Styling", minXP: 50 },
    { level: 3, name: "Interactie", minXP: 150 },
    { level: 4, name: "Formulieren", minXP: 300 },
    { level: 5, name: "AI Tekst", minXP: 500 },
    { level: 6, name: "AI Chat", minXP: 750 },
    { level: 7, name: "AI Tools", minXP: 1000 },
    { level: 8, name: "AI Apps", minXP: 1500 }
];

// Init
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Oefenruimte init...');
    loadStats();
    updateUI();
    
    // Check API key en laad opdracht indien nodig
    await checkApiKey();
});

// Load/Save stats
function loadStats() {
    const saved = localStorage.getItem('oefenruimte_stats');
    if (saved) {
        stats = JSON.parse(saved);
    }
}

function saveStats() {
    localStorage.setItem('oefenruimte_stats', JSON.stringify(stats));
}

// Check API key
async function checkApiKey() {
    try {
        const res = await fetch('/api/get-key');
        const data = await res.json();
        console.log('API Key check result:', data);
        
        if (data.has_key && data.key) {
            apiKey = data.key;
            document.getElementById('apiNotice').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            
            // Automatisch eerste opdracht laden
            console.log('API key found, generating assignment...');
            await generateAssignment();
        } else {
            console.log('No API key found');
            document.getElementById('assignmentLoading').classList.remove('show');
            document.getElementById('apiNotice').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('assignmentCard').style.display = 'none';
        }
    } catch(e) {
        console.error('API Key check error:', e);
        // Bij error, toon API notice zodat gebruiker key kan invoeren
        document.getElementById('assignmentLoading').classList.remove('show');
        document.getElementById('apiNotice').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
    }
}

// Called after API key is saved
window.onApiKeySet = async function() {
    console.log('API key was set, refreshing...');
    await checkApiKey();
};

// Update UI
function updateUI() {
    // Calculate level
    let currentLevel = LEVELS[0];
    for (const level of LEVELS) {
        if (stats.xp >= level.minXP) {
            currentLevel = level;
        }
    }
    stats.level = currentLevel.level;
    
    document.getElementById('currentLevel').textContent = stats.level;
    document.getElementById('levelName').textContent = currentLevel.name;
    document.getElementById('currentXP').textContent = stats.xp;
    
    // XP bar progress to next level
    const nextLevel = LEVELS.find(l => l.minXP > stats.xp) || LEVELS[LEVELS.length - 1];
    const prevLevel = LEVELS[Math.max(0, LEVELS.indexOf(nextLevel) - 1)];
    const progress = ((stats.xp - prevLevel.minXP) / (nextLevel.minXP - prevLevel.minXP)) * 100;
    document.getElementById('xpFill').style.width = Math.min(100, progress) + '%';
}

// Generate assignment
async function generateAssignment() {
    if (!apiKey) {
        openApiKeyModal();
        return;
    }

    console.log('Generating assignment for level:', stats.level);
    
    // Update loading text en toon
    const loadingEl = document.getElementById('assignmentLoading');
    loadingEl.querySelector('.loading-text').textContent = 'Opdracht genereren...';
    loadingEl.classList.add('show');
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('assignmentCard').style.display = 'none';

    try {
        const res = await fetch('/api/generate-assignment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: apiKey,
                level: stats.level,
                completed: stats.completed
            })
        });
        
        const data = await res.json();
        console.log('Assignment response:', data);
        
        if (data.success && data.assignment) {
            currentAssignment = data.assignment;
            displayAssignment(data.assignment);
        } else {
            console.error('Assignment error:', data.error);
            showToast(data.error || 'Kon geen opdracht genereren', 'error');
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch(e) {
        console.error('Generate assignment error:', e);
        showToast('Fout bij genereren opdracht: ' + e.message, 'error');
        document.getElementById('emptyState').style.display = 'block';
    }

    document.getElementById('assignmentLoading').classList.remove('show');
}

// Display assignment
function displayAssignment(assignment) {
    document.getElementById('assignmentCard').style.display = 'block';
    document.getElementById('assignmentLevel').textContent = `Level ${assignment.level} - ${assignment.level_name}`;
    document.getElementById('assignmentLevel').className = assignment.ai_integration ? 'assignment-level ai' : 'assignment-level';
    document.getElementById('assignmentXP').textContent = `+${assignment.base_xp} XP`;
    
    document.getElementById('clientEmoji').textContent = assignment.client_emoji || 'üë§';
    document.getElementById('clientName').textContent = assignment.client_name || 'Klant';
    document.getElementById('scenarioText').textContent = assignment.scenario || '';
    document.getElementById('taskText').textContent = assignment.task || '';
    
    // Requirements
    const reqList = document.getElementById('requirementsList');
    reqList.innerHTML = (assignment.requirements || []).map(req => 
        `<div class="requirement-item unmet">${req}</div>`
    ).join('');
    
    // Hints
    const hintsContent = document.getElementById('hintsContent');
    hintsContent.innerHTML = (assignment.hints || []).map(hint => 
        `<div class="hint-item">${hint}</div>`
    ).join('');
    hintsContent.classList.remove('show');
    
    // Reset preview
    document.getElementById('previewPlaceholder').style.display = 'flex';
    document.getElementById('previewFrame').classList.remove('show');
    document.getElementById('feedbackSection').classList.remove('show');
    document.getElementById('scorePercent').textContent = '-';
    document.getElementById('scorePercent').className = 'score-percent';
    document.getElementById('scoreFill').style.width = '0%';
    document.getElementById('promptInput').value = '';
}

// Toggle hints
function toggleHints() {
    const content = document.getElementById('hintsContent');
    const icon = document.getElementById('hintsIcon');
    content.classList.toggle('show');
    icon.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : '';
}

// Submit prompt
async function submitPrompt() {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) {
        showToast('Voer eerst een beschrijving in', 'error');
        return;
    }
    if (!currentAssignment) {
        showToast('Genereer eerst een opdracht', 'error');
        return;
    }

    document.getElementById('codeLoading').classList.add('show');
    document.getElementById('submitBtn').disabled = true;

    try {
        const res = await fetch('/api/submit-prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: apiKey,
                prompt: prompt,
                assignment: currentAssignment
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            displayResult(data);
        } else {
            showToast(data.error || 'Fout bij genereren', 'error');
        }
    } catch(e) {
        showToast('Fout bij verzenden', 'error');
    }

    document.getElementById('codeLoading').classList.remove('show');
    document.getElementById('submitBtn').disabled = false;
}

// Display result
function displayResult(data) {
    // Show preview
    const iframe = document.getElementById('previewIframe');
    const previewCode = data.code.replace('window.OPENAI_API_KEY', `'${apiKey}'`);
    iframe.srcdoc = previewCode;
    document.getElementById('previewPlaceholder').style.display = 'none';
    document.getElementById('previewFrame').classList.add('show');
    
    // Score
    const score = data.evaluation?.score || 0;
    const scoreEl = document.getElementById('scorePercent');
    scoreEl.textContent = score + '%';
    scoreEl.className = 'score-percent ' + (score >= 85 ? 'high' : score >= 50 ? 'mid' : 'low');
    
    document.getElementById('scoreFill').style.width = score + '%';
    document.getElementById('scoreFill').style.background = score >= 85 ? 'var(--green)' : score >= 50 ? 'var(--yellow)' : 'var(--red)';
    
    // Feedback
    const feedbackSection = document.getElementById('feedbackSection');
    const feedbackMessage = document.getElementById('feedbackMessage');
    feedbackSection.classList.add('show');
    
    if (score >= 85) {
        feedbackMessage.className = 'feedback-message success';
        feedbackMessage.innerHTML = `<i class="fas fa-check-circle"></i> Uitstekend! ${data.evaluation?.feedback || ''}`;
        
        // Add XP
        if (data.xp_earned > 0) {
            const oldLevel = stats.level;
            stats.xp += data.xp_earned;
            stats.completed.push(currentAssignment.title);
            saveStats();
            updateUI();
            
            showToast(`+${data.xp_earned} XP verdiend!`, 'success');
            
            // Check level up
            if (stats.level > oldLevel) {
                setTimeout(() => {
                    document.getElementById('levelupText').textContent = `Je bent nu Level ${stats.level}!`;
                    document.getElementById('levelupModal').classList.add('show');
                }, 500);
            }
        }
    } else if (score >= 50) {
        feedbackMessage.className = 'feedback-message partial';
        feedbackMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> Bijna! ${data.evaluation?.feedback || 'Probeer specifieker te zijn.'}`;
    } else {
        feedbackMessage.className = 'feedback-message fail';
        feedbackMessage.innerHTML = `<i class="fas fa-times-circle"></i> Nog niet helemaal. ${data.evaluation?.feedback || 'Lees de vereisten goed door.'}`;
    }
    
    // Update requirements
    const criteria = data.evaluation?.criteria_results || {};
    document.querySelectorAll('.requirement-item').forEach((el, i) => {
        const key = currentAssignment.success_criteria?.[i];
        if (key && criteria[key]) {
            el.classList.add('met');
            el.classList.remove('unmet');
        }
    });
}

// Close level up modal
function closeLevelUp() {
    document.getElementById('levelupModal').classList.remove('show');
}

// Enable submit when typing
document.getElementById('promptInput').addEventListener('input', function() {
    document.getElementById('submitBtn').disabled = !this.value.trim() || !apiKey;
});
</script>
{% endblock %}
