{% extends "base.html" %}

{% block title %}Oefenruimte - Leer Vibecoding met Opdrachten | LeerVibeCoding{% endblock %}

{% block meta_description %}Oefen vibecoding met interactieve opdrachten. Van HTML basics tot complete AI-apps. Krijg direct feedback op je prompts en zie je code live in actie.{% endblock %}

{% block meta_keywords %}vibecoding oefenen, programmeren leren interactief, AI coding opdrachten, HTML leren, JavaScript leren, coding oefeningen Nederlands{% endblock %}

{% block canonical %}https://leervibecoding.nl/oefenruimte{% endblock %}
{% block og_url %}https://leervibecoding.nl/oefenruimte{% endblock %}
{% block og_title %}Oefenruimte - Leer door te doen{% endblock %}
{% block og_description %}Interactieve opdrachten om vibecoding te leren. Van beginner tot gevorderd, op je eigen tempo.{% endblock %}

{% block extra_css %}
<style>
    body { background: var(--bg); overflow-x: hidden; }
    
    /* Header */
    .studio-header {
        padding: 12px 0;
        background: var(--nav-bg);
        border-bottom: 1px solid var(--border);
        position: sticky; top: 0; z-index: 100;
    }
    .studio-header-inner {
        display: flex; justify-content: space-between; align-items: center;
        flex-wrap: wrap; gap: 12px;
    }
    .studio-title { font-size: 20px; display: flex; align-items: center; gap: 10px; color: var(--text1); }
    .studio-title span { 
        background: linear-gradient(135deg, var(--purple), var(--cyan));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        font-weight: 700;
    }
    
    /* Level & XP */
    .stats-bar { display: flex; align-items: center; gap: 20px; }
    .level-display {
        display: flex; align-items: center; gap: 10px;
        background: var(--purple-light); padding: 8px 16px; border-radius: 20px;
    }
    .level-num { font-size: 18px; font-weight: 700; color: var(--purple); }
    .level-name { font-size: 12px; color: var(--text3); }
    .xp-display { font-size: 16px; color: var(--yellow); font-weight: 600; }
    .xp-bar { width: 120px; height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; }
    .xp-fill { height: 100%; background: linear-gradient(90deg, var(--yellow), var(--orange)); border-radius: 10px; transition: width 0.5s; }

    /* Main Studio Layout */
    .studio-main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 60px);
    }

    /* Left Panel - Assignment & Input */
    .left-panel {
        display: flex; flex-direction: column;
        background: var(--bg2);
        border-right: 1px solid var(--border);
        overflow: hidden;
    }

    /* Assignment Section */
    .assignment-section { padding: 20px; flex: 1; overflow-y: auto; position: relative; }
    
    .assignment-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px; padding: 20px; margin-bottom: 16px;
        box-shadow: 0 4px 15px var(--shadow);
    }
    .assignment-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .assignment-level {
        background: var(--purple-light); padding: 4px 12px; border-radius: 12px;
        font-size: 11px; font-weight: 600; color: var(--purple); text-transform: uppercase;
    }
    .assignment-level.ai { background: var(--green-light); color: var(--green); }
    
    .client-info { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .client-avatar { font-size: 36px; }
    .client-name { font-size: 18px; font-weight: 600; color: var(--orange); }
    
    .scenario-text { color: var(--text); font-size: 15px; line-height: 1.6; margin-bottom: 16px; }
    .scenario-text * {
        font-size: inherit !important;
        font-family: inherit !important;
        line-height: inherit !important;
        margin: 0 !important;
        display: inline !important;
    }
    
    .task-box {
        background: var(--green-light); border: 1px solid var(--green);
        border-radius: 12px; padding: 14px; margin-bottom: 16px;
    }
    .task-label { font-size: 11px; color: var(--green); font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
    .task-text { color: var(--text1); font-size: 14px; line-height: 1.5; }
    .task-text * {
        font-size: inherit !important;
        font-family: inherit !important;
        line-height: inherit !important;
        margin: 0 !important;
        display: inline !important;
    }
    .task-text code {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace !important;
        background: rgba(34,197,94,0.2) !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-size: 13px !important;
    }

    /* Requirements checklist */
    .requirements-box { margin-bottom: 16px; }
    .requirements-title { font-size: 13px; color: var(--text3); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .requirement-item {
        display: flex; align-items: flex-start; gap: 8px;
        padding: 10px 14px; margin-bottom: 6px;
        background: var(--glass); border-radius: 8px;
        font-size: 14px; color: var(--text2);
        line-height: 1.5;
    }
    /* Zorg dat ALLE tekst in requirements dezelfde stijl heeft */
    .requirement-item * {
        font-size: inherit !important;
        font-family: inherit !important;
        font-weight: inherit !important;
        line-height: inherit !important;
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
        background: none !important;
        border: none !important;
    }
    .requirement-item code,
    .requirement-item pre {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace !important;
        background: rgba(124,58,237,0.15) !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-size: 13px !important;
        color: var(--purple) !important;
    }
    .requirement-item.met { background: var(--green-light); color: var(--green); }
    .requirement-item.met::before { content: "‚úì"; color: var(--green); font-weight: bold; flex-shrink: 0; }
    .requirement-item.unmet::before { content: "‚óã"; color: var(--text3); flex-shrink: 0; }

    /* Hints */
    .hints-toggle {
        background: rgba(59,130,246,0.1); border: 1px solid var(--blue);
        border-radius: 10px; padding: 12px; cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
        color: var(--blue); font-size: 13px; font-weight: 500;
    }
    .hints-toggle:hover { background: rgba(59,130,246,0.15); }
    .hints-content { display: none; padding: 12px; background: rgba(59,130,246,0.05); border-radius: 0 0 10px 10px; margin-top: -1px; }
    .hints-content.show { display: block; }
    .hint-item { color: var(--text2); font-size: 14px; margin-bottom: 8px; padding-left: 24px; position: relative; line-height: 1.5; }
    .hint-item::before { content: "üí°"; position: absolute; left: 0; }
    .hint-item * {
        font-size: inherit !important;
        font-family: inherit !important;
        font-weight: inherit !important;
        line-height: inherit !important;
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
        background: none !important;
        border: none !important;
    }
    .hint-item code,
    .hint-item pre {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace !important;
        background: rgba(59,130,246,0.15) !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-size: 13px !important;
        color: var(--blue) !important;
    }

    /* Input Section */
    .input-section {
        padding: 16px 20px;
        background: var(--bg3);
        border-top: 1px solid var(--border);
        flex-shrink: 0;
    }
    .input-label { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text1); }
    .prompt-input {
        width: 100%; min-height: 80px; padding: 14px;
        background: var(--card-bg); border: 2px solid var(--border);
        border-radius: 12px; color: var(--text); font-family: inherit; font-size: 14px;
        resize: none; transition: all 0.3s;
    }
    .prompt-input:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 20px rgba(147,51,234,0.2); }
    .prompt-input::placeholder { color: var(--text3); }
    
    .btn-row { display: flex; gap: 10px; margin-top: 12px; }
    .btn-submit {
        flex: 1; padding: 14px;
        background: linear-gradient(135deg, var(--green), #16a34a);
        border: none; border-radius: 10px; color: white;
        font-size: 15px; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: all 0.3s;
    }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(22,163,74,0.4); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-retry {
        flex: 1; padding: 14px;
        background: linear-gradient(135deg, var(--orange), #d97706);
        border: none; border-radius: 10px; color: white;
        font-size: 15px; font-weight: 600; cursor: pointer;
        display: none; align-items: center; justify-content: center; gap: 8px;
        transition: all 0.3s;
    }
    .btn-retry:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(234,88,12,0.4); }
    .btn-retry.show { display: flex; }
    
    .btn-new {
        padding: 14px 20px;
        background: var(--purple-light); border: 1px solid var(--purple);
        border-radius: 10px; color: var(--purple);
        font-size: 14px; cursor: pointer;
    }
    .btn-new:hover { background: var(--purple); color: white; }

    /* Right Panel - Preview */
    .right-panel {
        display: flex; flex-direction: column;
        background: var(--bg);
    }

    /* Score Bar */
    .score-bar {
        padding: 12px 20px;
        background: var(--bg2);
        border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .score-label { font-size: 13px; color: var(--text3); }
    .score-display { display: flex; align-items: center; gap: 12px; }
    .score-percent { font-size: 24px; font-weight: 700; color: var(--text3); }
    .score-percent.low { color: var(--red); }
    .score-percent.mid { color: var(--orange); }
    .score-percent.high { color: var(--green); }
    .score-percent.perfect { color: var(--cyan); text-shadow: 0 0 20px rgba(8,145,178,0.5); }
    .score-bar-visual { width: 150px; height: 8px; background: var(--border); border-radius: 10px; overflow: hidden; }
    .score-bar-fill { height: 100%; border-radius: 10px; transition: all 0.5s; background: var(--text3); }

    /* Preview Area */
    .preview-area { flex: 1; position: relative; padding: 16px; overflow: hidden; }
    
    .preview-placeholder {
        height: 100%;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        text-align: center; color: var(--text3);
    }
    .preview-placeholder-icon { font-size: 80px; margin-bottom: 16px; opacity: 0.3; }
    .preview-placeholder-text { font-size: 18px; margin-bottom: 8px; }
    .preview-placeholder-sub { font-size: 14px; }
    
    .preview-frame {
        display: none;
        width: 100%; height: 100%;
        background: white; border-radius: 12px;
        overflow: hidden; box-shadow: 0 20px 60px var(--shadow);
    }
    .preview-frame.show { display: block; }
    .preview-frame iframe { width: 100%; height: 100%; border: none; }

    /* Feedback Section */
    .feedback-section {
        padding: 16px 20px;
        background: var(--bg2);
        border-top: 1px solid var(--border);
        display: none; max-height: 200px; overflow-y: auto;
    }
    .feedback-section.show { display: block; }
    
    .feedback-message {
        padding: 12px; border-radius: 10px; margin-bottom: 12px;
        font-size: 14px; font-weight: 500;
    }
    .feedback-message.success { background: var(--green-light); border: 1px solid var(--green); color: var(--green); }
    .feedback-message.partial { background: var(--yellow-light); border: 1px solid var(--yellow); color: var(--yellow); }
    .feedback-message.fail { background: var(--red-light); border: 1px solid var(--red); color: var(--red); }
    
    .suggestions-box { background: var(--glass); border-radius: 10px; padding: 12px; border: 1px solid var(--border); }
    .suggestions-title { font-size: 12px; color: var(--text3); margin-bottom: 8px; }
    .suggestion-item {
        display: flex; align-items: flex-start; gap: 8px;
        padding: 8px; margin-bottom: 6px;
        background: var(--purple-light); border-radius: 8px;
        font-size: 13px; color: var(--text);
        cursor: pointer; transition: all 0.2s;
    }
    .suggestion-item:hover { background: var(--purple); color: white; }
    .suggestion-item i { color: var(--purple); margin-top: 2px; }
    .suggestion-item:hover i { color: white; }

    /* Loading States */
    .loading-overlay {
        position: absolute; inset: 0;
        background: rgba(0,0,0,0.7);
        display: none; align-items: center; justify-content: center;
        flex-direction: column; gap: 16px; z-index: 10;
    }
    .loading-overlay.show { display: flex; }
    .spinner {
        width: 50px; height: 50px;
        border: 4px solid var(--border);
        border-top-color: var(--purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: white; font-size: 14px; }

    /* Level Up Modal */
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.8);
        display: none; align-items: center; justify-content: center;
        z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
        background: var(--card-bg);
        border: 2px solid var(--purple);
        border-radius: 24px; padding: 40px;
        text-align: center; max-width: 400px;
        animation: popIn 0.3s ease;
        box-shadow: 0 20px 60px var(--shadow);
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-emoji { font-size: 64px; margin-bottom: 16px; }
    .modal-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; color: var(--purple); }
    .modal-text { font-size: 16px; color: var(--text2); margin-bottom: 24px; }
    .modal-btn {
        padding: 14px 32px;
        background: linear-gradient(135deg, var(--purple), var(--blue));
        border: none; border-radius: 12px; color: white;
        font-size: 16px; font-weight: 600; cursor: pointer;
    }

    /* API Key Notice */
    /* API Key Modal */
    .api-key-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(8px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
    }
    .api-key-overlay.show { display: flex; }
    .api-key-modal {
        background: var(--card-bg);
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
    }
    .api-key-header {
        padding: 30px 30px 20px;
        text-align: center;
        border-bottom: 1px solid var(--border);
    }
    .api-key-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    .api-key-header h2 {
        font-size: 24px;
        color: var(--text1);
        margin-bottom: 8px;
    }
    .api-key-header p {
        color: var(--text2);
        font-size: 15px;
    }
    .api-key-body {
        padding: 30px;
    }
    .api-info-block {
        background: var(--bg2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .api-info-block h4 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        color: var(--text1);
        margin-bottom: 12px;
    }
    .api-info-block h4 i {
        color: var(--purple);
    }
    .api-info-block p {
        color: var(--text2);
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 12px;
    }
    .api-info-block p:last-child {
        margin-bottom: 0;
    }
    .api-info-block.security {
        border-color: var(--green);
        background: var(--green-light);
    }
    .api-info-block.security h4 i {
        color: var(--green);
    }
    .api-info-block ol {
        margin: 0;
        padding-left: 20px;
        color: var(--text2);
        font-size: 14px;
        line-height: 1.8;
    }
    .api-info-block ol li {
        margin-bottom: 8px;
    }
    .api-info-block a {
        color: var(--purple);
        font-weight: 600;
    }
    .api-key-form {
        margin-top: 24px;
    }
    .api-key-form label {
        display: block;
        font-size: 14px;
        color: var(--text2);
        margin-bottom: 8px;
    }
    .api-key-form input {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg2);
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 16px;
        color: var(--text1);
        margin-bottom: 16px;
    }
    .api-key-form input:focus {
        outline: none;
        border-color: var(--purple);
    }
    .api-key-form .submit-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, var(--green), #16a34a);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s;
    }
    .api-key-form .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(34,197,94,0.3);
    }
    .api-key-error {
        color: var(--red);
        font-size: 14px;
        margin-top: 12px;
        display: none;
    }
    .api-key-error.show {
        display: block;
    }

    /* Hide old api-notice */
    .api-notice { display: none !important; }

    /* Responsive */
    @media (max-width: 1024px) {
        .studio-header-inner {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        .stats-bar {
            width: 100%;
            justify-content: space-between;
        }
    }

    @media (max-width: 900px) {
        .studio-main {
            grid-template-columns: 1fr;
            height: auto;
            min-height: calc(100vh - 120px);
        }
        .left-panel {
            border-right: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            max-height: none;
        }
        .right-panel {
            min-height: 60vh;
        }
        .assignment-section {
            padding: 16px;
        }
        .prompt-section {
            padding: 16px;
        }
    }

    @media (max-width: 768px) {
        .studio-header {
            padding: 10px 0;
            top: 70px;
        }
        .studio-title {
            font-size: 18px;
        }
        .stats-bar {
            gap: 12px;
            flex-wrap: wrap;
        }
        .level-display {
            padding: 6px 12px;
        }
        .level-num {
            font-size: 14px;
        }
        .xp-display {
            font-size: 14px;
        }
        .xp-bar {
            width: 80px;
        }
        .assignment-card {
            padding: 16px;
        }
        .client-avatar {
            font-size: 28px;
        }
        .client-name {
            font-size: 16px;
        }
        .scenario-text {
            font-size: 14px;
        }
        .task-box {
            padding: 12px;
        }
        .task-text {
            font-size: 13px;
        }
        .requirement-item {
            font-size: 12px;
            padding: 6px 10px;
        }
        .right-panel {
            min-height: 50vh;
        }
        .preview-header {
            padding: 12px;
        }
        .score-panel {
            padding: 12px;
        }
        .score-value {
            font-size: 42px;
        }
    }

    @media (max-width: 480px) {
        .studio-header {
            top: 65px;
        }
        .studio-header-inner {
            gap: 8px;
        }
        .studio-title {
            font-size: 16px;
        }
        .studio-title span {
            font-size: 16px;
        }
        .stats-bar {
            gap: 8px;
        }
        .level-display {
            padding: 5px 10px;
            gap: 6px;
        }
        .level-num {
            font-size: 13px;
        }
        .level-name {
            display: none;
        }
        .xp-display {
            font-size: 13px;
        }
        .xp-bar {
            width: 60px;
            height: 4px;
        }
        .assignment-section,
        .prompt-section {
            padding: 12px;
        }
        .assignment-card {
            padding: 14px;
            border-radius: 12px;
        }
        .client-info {
            gap: 10px;
        }
        .client-avatar {
            font-size: 24px;
        }
        .client-name {
            font-size: 15px;
        }
        .scenario-text {
            font-size: 13px;
            line-height: 1.5;
        }
        .task-label {
            font-size: 10px;
        }
        .task-text {
            font-size: 12px;
        }
        .prompt-label {
            font-size: 13px;
        }
        .prompt-textarea {
            font-size: 14px;
            padding: 12px;
            min-height: 100px;
        }
        .prompt-actions {
            flex-direction: column;
        }
        .prompt-actions button {
            width: 100%;
            justify-content: center;
        }
        .preview-placeholder {
            font-size: 14px;
        }
        .preview-placeholder .icon {
            font-size: 40px;
        }
        .api-notice {
            flex-direction: column;
            text-align: center;
            padding: 12px;
            gap: 8px;
        }
        .api-notice button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- API Key Modal -->
<div class="api-key-overlay" id="apiKeyOverlay">
    <div class="api-key-modal">
        <div class="api-key-header">
            <div class="api-key-icon">üîë</div>
            <h2>OpenAI API Key Nodig</h2>
            <p>Om de leeromgeving te gebruiken heb je een API key van OpenAI nodig.</p>
        </div>
        <div class="api-key-body">
            <div class="api-info-block">
                <h4><i class="fas fa-question-circle"></i> Wat is een API key?</h4>
                <p>Een API key is een persoonlijke sleutel waarmee jij toegang krijgt tot de AI van OpenAI (dezelfde technologie achter ChatGPT). Het is als een wachtwoord dat alleen jij hebt.</p>
            </div>
            
            <div class="api-info-block">
                <h4><i class="fas fa-lightbulb"></i> Waarom heb ik dit nodig?</h4>
                <p>De leeromgeving gebruikt AI om je opdrachten te genereren en feedback te geven op je werk. Hiervoor hebben we toegang tot OpenAI nodig via jouw eigen key.</p>
                <p>Op deze manier betaal je alleen voor je eigen gebruik en hebben wij geen controle over je account.</p>
            </div>
            
            <div class="api-info-block security">
                <h4><i class="fas fa-shield-alt"></i> Veiligheid & Privacy</h4>
                <p><strong>Wij slaan jouw API key NIET op onze servers op.</strong></p>
                <p>Je key wordt alleen lokaal in je browser opgeslagen en direct naar OpenAI gestuurd. Wij hebben geen inzicht in je key, je verbruik, of je OpenAI account. Zodra je je browser sluit of de key verwijdert, is deze volledig weg.</p>
            </div>
            
            <div class="api-info-block">
                <h4><i class="fas fa-key"></i> Hoe krijg ik een API key?</h4>
                <ol>
                    <li>Ga naar <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></li>
                    <li>Maak een account aan of log in</li>
                    <li>Klik op <strong>"Create new secret key"</strong></li>
                    <li>Kopieer de key (begint met <code>sk-</code>)</li>
                    <li>Plak hem hieronder</li>
                </ol>
                <p style="margin-top: 12px; font-size: 13px; color: var(--text3);">üí° Nieuwe gebruikers krijgen vaak gratis tegoed van OpenAI om te starten.</p>
            </div>
            
            <div class="api-key-form">
                <label for="apiKeyInput">Jouw API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
                <button class="submit-btn" onclick="submitApiKey()">
                    <i class="fas fa-check"></i> Activeren en Starten
                </button>
                <div class="api-key-error" id="apiKeyError">
                    <i class="fas fa-exclamation-circle"></i> <span id="apiKeyErrorText">Ongeldige API key</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Old API Notice (hidden, kept for backwards compatibility) -->
<div class="api-notice" id="apiNotice">
    <i class="fas fa-key"></i>
    <span>Voer eerst je OpenAI API key in om te beginnen</span>
    <button onclick="openApiKeyModal()">API Key Invoeren</button>
</div>

<!-- Header -->
<header class="studio-header">
    <div class="container">
        <div class="studio-header-inner">
            <div class="studio-title">
                <span>üé¨ Oefenruimte</span>
            </div>
            <div class="stats-bar">
                <div class="level-display">
                    <span class="level-num">Level <span id="currentLevel">1</span></span>
                    <span class="level-name" id="levelName">HTML Basics</span>
                </div>
                <div class="xp-display"><span id="totalXp">0</span> XP</div>
                <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
</header>

<!-- Main Studio -->
<main class="studio-main">
    <!-- Left: Assignment & Input -->
    <div class="left-panel">
        <div class="assignment-section" id="assignmentSection">
            <!-- Assignment Card -->
            <div class="assignment-card" id="assignmentCard">
                <div class="assignment-header">
                    <span class="assignment-level" id="assignmentLevel">Level 1</span>
                </div>
                <div class="client-info">
                    <span class="client-avatar" id="clientEmoji">üè™</span>
                    <span class="client-name" id="clientName">Laden...</span>
                </div>
                <p class="scenario-text" id="scenarioText">Je opdracht wordt gegenereerd...</p>
                
                <div class="task-box">
                    <div class="task-label">‚úÖ Jouw Opdracht</div>
                    <div class="task-text" id="taskText">Even geduld...</div>
                </div>

                <div class="requirements-box" id="requirementsBox">
                    <div class="requirements-title"><i class="fas fa-list-check"></i> Requirements</div>
                    <div id="requirementsList"></div>
                </div>

                <div class="hints-toggle" onclick="toggleHints()">
                    <span><i class="fas fa-lightbulb"></i> Tips nodig?</span>
                    <i class="fas fa-chevron-down" id="hintsIcon"></i>
                </div>
                <div class="hints-content" id="hintsContent"></div>
            </div>

            <!-- Loading for assignment -->
            <div class="loading-overlay" id="assignmentLoading">
                <div class="spinner"></div>
                <div class="loading-text">Opdracht genereren...</div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-label">üí¨ Vertel de AI wat je wilt bouwen:</div>
            <textarea class="prompt-input" id="promptInput" placeholder="Beschrijf zo specifiek mogelijk wat je wilt. Denk aan: structuur, kleuren, functionaliteit, teksten..."></textarea>
            <div class="btn-row">
                <button class="btn-submit" id="submitBtn" onclick="submitPrompt()">
                    <i class="fas fa-wand-magic-sparkles"></i> Genereer!
                </button>
                <button class="btn-retry" id="retryBtn" onclick="retryPrompt()">
                    <i class="fas fa-redo"></i> Opnieuw Proberen
                </button>
                <button class="btn-new" onclick="newAssignment()">
                    <i class="fas fa-forward"></i> Volgende Opdracht
                </button>
            </div>
        </div>
    </div>

    <!-- Right: Preview -->
    <div class="right-panel">
        <!-- Score Bar -->
        <div class="score-bar">
            <span class="score-label">Score</span>
            <div class="score-display">
                <span class="score-percent" id="scorePercent">--%</span>
                <div class="score-bar-visual">
                    <div class="score-bar-fill" id="scoreFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="preview-area">
            <div class="preview-placeholder" id="previewPlaceholder">
                <div class="preview-placeholder-icon">üñºÔ∏è</div>
                <div class="preview-placeholder-text">Hier verschijnt je creatie</div>
                <div class="preview-placeholder-sub">Schrijf je prompt en klik op "Genereer!"</div>
            </div>
            
            <div class="preview-frame" id="previewFrame">
                <iframe id="previewIframe"></iframe>
            </div>

            <div class="loading-overlay" id="previewLoading">
                <div class="spinner"></div>
                <div class="loading-text">Code genereren & evalueren...</div>
            </div>
        </div>

        <!-- Feedback Section -->
        <div class="feedback-section" id="feedbackSection">
            <div class="feedback-message" id="feedbackMessage"></div>
            <div class="suggestions-box" id="suggestionsBox">
                <div class="suggestions-title">üí° Verbeter je prompt:</div>
                <div id="suggestionsList"></div>
            </div>
        </div>
    </div>
</main>

<!-- Level Up Modal -->
<div class="modal-overlay" id="levelUpModal">
    <div class="modal-box">
        <div class="modal-emoji">üéâ</div>
        <div class="modal-title">Level Up!</div>
        <div class="modal-text" id="levelUpText">Je hebt level 2 bereikt: Styling</div>
        <button class="modal-btn" onclick="closeLevelUpModal()">Doorgaan</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let apiKey = localStorage.getItem('openai_key') || '';
let currentLevel = parseInt(localStorage.getItem('vibe_level') || '1');
let totalXp = parseInt(localStorage.getItem('vibe_xp') || '0');
let completedAssignments = JSON.parse(localStorage.getItem('vibe_completed') || '[]');
let currentAssignment = null;
let currentBestScore = 0; // Track best score for current assignment
let hasEarnedXpThisAssignment = false;

// Level thresholds
const levelThresholds = [0, 50, 150, 300, 500, 750, 1000, 1500, 2500];
const levelNames = ['', 'HTML Basics', 'Styling', 'Interactie', 'Formulieren', 'AI Tekst', 'AI Chat', 'AI Tools', 'AI Apps'];

// Init
document.addEventListener('DOMContentLoaded', () => {
    updateUI();
    
    if (!apiKey) {
        document.getElementById('apiKeyOverlay').classList.add('show');
    } else {
        loadAssignment();
    }
});

function updateUI() {
    document.getElementById('currentLevel').textContent = currentLevel;
    document.getElementById('levelName').textContent = levelNames[currentLevel] || 'Master';
    document.getElementById('totalXp').textContent = totalXp;
    
    // XP progress to next level
    const currentThreshold = levelThresholds[currentLevel - 1] || 0;
    const nextThreshold = levelThresholds[currentLevel] || levelThresholds[levelThresholds.length - 1];
    const progress = ((totalXp - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
    document.getElementById('xpFill').style.width = Math.min(progress, 100) + '%';
}

function submitApiKey() {
    const input = document.getElementById('apiKeyInput');
    const key = input.value.trim();
    const errorEl = document.getElementById('apiKeyError');
    const errorText = document.getElementById('apiKeyErrorText');
    
    if (!key) {
        errorText.textContent = 'Voer een API key in';
        errorEl.classList.add('show');
        return;
    }
    
    if (!key.startsWith('sk-')) {
        errorText.textContent = 'API key moet beginnen met "sk-"';
        errorEl.classList.add('show');
        return;
    }
    
    errorEl.classList.remove('show');
    apiKey = key;
    localStorage.setItem('openai_key', key);
    document.getElementById('apiKeyOverlay').classList.remove('show');
    loadAssignment();
}

function openApiKeyModal() {
    document.getElementById('apiKeyOverlay').classList.add('show');
}

async function loadAssignment() {
    document.getElementById('assignmentLoading').classList.add('show');
    
    try {
        const response = await fetch('/api/generate-assignment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: apiKey,
                level: currentLevel,
                completed: completedAssignments
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentAssignment = data.assignment;
            displayAssignment(currentAssignment);
        } else {
            alert('Fout: ' + data.error);
        }
    } catch (e) {
        alert('Verbindingsfout: ' + e.message);
    } finally {
        document.getElementById('assignmentLoading').classList.remove('show');
    }
}

function displayAssignment(assignment) {
    document.getElementById('assignmentLevel').textContent = `Level ${assignment.level} - ${assignment.level_name}`;
    document.getElementById('assignmentLevel').classList.toggle('ai', assignment.ai_integration);
    document.getElementById('clientEmoji').textContent = assignment.client_emoji || 'üë§';
    document.getElementById('clientName').textContent = assignment.client_name || 'Klant';
    document.getElementById('scenarioText').textContent = assignment.scenario;
    document.getElementById('taskText').textContent = assignment.task;
    
    // Helper functie om HTML tags te highlighten (niet renderen)
    function formatRequirement(text) {
        // Escape HTML eerst
        let escaped = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        // Highlight code/tags met styled spans
        escaped = escaped.replace(/&lt;(\/?[a-zA-Z0-9]+)&gt;/g, '<code>&lt;$1&gt;</code>');
        return escaped;
    }
    
    // Requirements
    const reqList = document.getElementById('requirementsList');
    reqList.innerHTML = (assignment.requirements || []).map(req => 
        `<div class="requirement-item unmet">${formatRequirement(req)}</div>`
    ).join('');
    
    // Hints
    const hintsContent = document.getElementById('hintsContent');
    hintsContent.innerHTML = (assignment.hints || []).map(hint =>
        `<div class="hint-item">${formatRequirement(hint)}</div>`
    ).join('');
    hintsContent.classList.remove('show');
    
    // Reset UI
    document.getElementById('previewPlaceholder').style.display = 'flex';
    document.getElementById('previewFrame').classList.remove('show');
    document.getElementById('feedbackSection').classList.remove('show');
    document.getElementById('scorePercent').textContent = '--%';
    document.getElementById('scorePercent').className = 'score-percent';
    document.getElementById('scoreFill').style.width = '0%';
    document.getElementById('promptInput').value = '';
    document.getElementById('retryBtn').classList.remove('show');
    
    // Reset score tracking
    currentBestScore = 0;
    hasEarnedXpThisAssignment = false;
}

function toggleHints() {
    const content = document.getElementById('hintsContent');
    const icon = document.getElementById('hintsIcon');
    content.classList.toggle('show');
    icon.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : '';
}

async function submitPrompt() {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) {
        alert('Schrijf eerst een prompt!');
        return;
    }
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Genereren...';
    document.getElementById('previewLoading').classList.add('show');
    
    try {
        const response = await fetch('/api/submit-prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: apiKey,
                prompt: prompt,
                assignment: currentAssignment
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResult(data);
        } else {
            alert('Fout: ' + data.error);
        }
    } catch (e) {
        alert('Verbindingsfout: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Genereer!';
        document.getElementById('previewLoading').classList.remove('show');
    }
}

function displayResult(data) {
    // Show preview
    document.getElementById('previewPlaceholder').style.display = 'none';
    document.getElementById('previewFrame').classList.add('show');
    
    // Inject API key into iframe for AI-powered features
    let code = data.code;
    if (currentAssignment.ai_integration) {
        code = code.replace(
            '</head>',
            `<script>window.OPENAI_API_KEY = "${apiKey}";<\/script></head>`
        );
    }
    
    document.getElementById('previewIframe').srcdoc = code;
    
    // Update score
    const score = data.evaluation?.score || 0;
    const scoreEl = document.getElementById('scorePercent');
    scoreEl.textContent = score + '%';
    scoreEl.className = 'score-percent ' + (
        score >= 100 ? 'perfect' :
        score >= 80 ? 'high' :
        score >= 50 ? 'mid' : 'low'
    );
    
    const fillEl = document.getElementById('scoreFill');
    fillEl.style.width = score + '%';
    fillEl.style.background = 
        score >= 100 ? 'linear-gradient(90deg, #22d3ee, #a855f7)' :
        score >= 80 ? '#22c55e' :
        score >= 50 ? '#f59e0b' : '#ef4444';
    
    // Update requirements checklist
    const criteriaResults = data.evaluation?.criteria_results || {};
    const reqItems = document.querySelectorAll('.requirement-item');
    Object.entries(criteriaResults).forEach(([key, met]) => {
        // Find matching requirement item
        reqItems.forEach(item => {
            if (met && item.textContent.toLowerCase().includes(key.toLowerCase())) {
                item.classList.remove('unmet');
                item.classList.add('met');
            }
        });
    });
    
    // Feedback
    const feedbackSection = document.getElementById('feedbackSection');
    const feedbackMessage = document.getElementById('feedbackMessage');
    
    feedbackSection.classList.add('show');
    
    let feedbackText = data.evaluation?.feedback || 'Resultaat gegenereerd';
    if (score >= 100) {
        feedbackText = 'üéâ Perfect! ' + feedbackText;
    } else if (score >= 85) {
        feedbackText = 'üëç Uitstekend! ' + feedbackText + ' (+XP)';
    } else if (score >= 70) {
        feedbackText = '‚úÖ Goed! ' + feedbackText + ' (+XP) ‚Äî Wil je nog verbeteren?';
    } else if (score >= 50) {
        feedbackText = 'üòä Op de goede weg! ' + feedbackText + ' ‚Äî Nog even doorwerken!';
    } else {
        feedbackText = 'üí™ ' + feedbackText + ' ‚Äî Pas je prompt aan!';
    }
    
    feedbackMessage.textContent = feedbackText;
    feedbackMessage.className = 'feedback-message ' + (
        score >= 85 ? 'success' :
        score >= 70 ? 'success' :
        score >= 50 ? 'partial' : 'fail'
    );
    
    // Suggestions
    const suggestionsList = document.getElementById('suggestionsList');
    const suggestions = data.evaluation?.suggestions || [];
    const missing = data.evaluation?.missing || [];
    
    if (suggestions.length || missing.length) {
        document.getElementById('suggestionsBox').style.display = 'block';
        suggestionsList.innerHTML = [
            ...missing.map(m => `<div class="suggestion-item"><i class="fas fa-exclamation-circle"></i> Mist: ${m}</div>`),
            ...suggestions.map(s => `<div class="suggestion-item" onclick="addToPrompt(this.dataset.text)" data-text="${s.replace(/"/g, '&quot;')}"><i class="fas fa-plus"></i> ${s}</div>`)
        ].join('');
    } else {
        document.getElementById('suggestionsBox').style.display = 'none';
    }
    
    // XP - meer XP bij hogere scores (70%+)
    if (score > currentBestScore) {
        currentBestScore = score;
        
        // XP bij 70% of hoger
        if (score >= 70 && !hasEarnedXpThisAssignment) {
            totalXp += data.xp_earned;
            localStorage.setItem('vibe_xp', totalXp);
            hasEarnedXpThisAssignment = true;
            
            if (score >= 100) {
                completedAssignments.push(currentAssignment.title);
                localStorage.setItem('vibe_completed', JSON.stringify(completedAssignments));
            }
            
            checkLevelUp();
        }
        updateUI();
    }
    
    // Show/hide retry button - altijd tonen behalve bij 100%
    if (score < 100) {
        document.getElementById('retryBtn').classList.add('show');
    } else {
        document.getElementById('retryBtn').classList.remove('show');
    }
}

function addToPrompt(text) {
    const input = document.getElementById('promptInput');
    input.value += (input.value ? '\n' : '') + text;
    input.focus();
}

function retryPrompt() {
    // Focus op het prompt input veld zodat gebruiker kan aanpassen
    document.getElementById('promptInput').focus();
    document.getElementById('promptInput').scrollIntoView({ behavior: 'smooth' });
}

function checkLevelUp() {
    const nextThreshold = levelThresholds[currentLevel];
    if (nextThreshold && totalXp >= nextThreshold && currentLevel < 8) {
        currentLevel++;
        localStorage.setItem('vibe_level', currentLevel);
        
        document.getElementById('levelUpText').textContent = 
            `Je hebt Level ${currentLevel} bereikt: ${levelNames[currentLevel]}!`;
        document.getElementById('levelUpModal').classList.add('show');
    }
}

function closeLevelUpModal() {
    document.getElementById('levelUpModal').classList.remove('show');
    updateUI();
    // NIET automatisch nieuwe opdracht laden - gebruiker beslist zelf
}

function newAssignment() {
    loadAssignment();
}
</script>
{% endblock %}
